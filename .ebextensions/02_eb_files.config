files: 
  "/opt/elasticbeanstalk/hooks/appdeploy/enact/02flip.sh" :
    mode: "000750"
    owner: root
    group: root
    content: |
      #!/bin/bash

      set -e

      . /opt/elasticbeanstalk/hooks/common.sh

      EB_APP_DEPLOY_DIR=$(/opt/elasticbeanstalk/bin/get-config container -k app_deploy_dir)

      EB_RUNNING_CONTAINER_ID=$(docker ps -q)
      EB_CONFIG_NGINX_UPSTREAM_IP=$(docker inspect --format '{{ .NetworkSettings.IPAddress }}' $EB_RUNNING_CONTAINER_ID)
 
      # Configure Nginx
      cp $EB_APP_DEPLOY_DIR/.ebextensions/.nginx/proxy/* /etc/nginx/sites-available/
      
      # set up symlinks
      FILES=$(ls /etc/nginx/sites-available/)
      for f in $FILES
      do
          ln -s /etc/nginx/sites-available/$f /etc/nginx/sites-enabled/ > /dev/null 2>&1
      done 
      
      # Check if this has been done already
      cat >> /etc/nginx/conf.d/elasticbeanstalk-nginx-docker-upstream.conf <<EOF
      upstream docker {
           server $EB_CONFIG_NGINX_UPSTREAM_IP:80;
           keepalive 256;
      }
      upstream jupyter {
           server $EB_CONFIG_NGINX_UPSTREAM_IP:3335;
           keepalive 256;
      }
      upstream sifu {
           server $EB_CONFIG_NGINX_UPSTREAM_IP:3334;
           keepalive 256;
      }
      EOF
